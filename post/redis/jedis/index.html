<!DOCTYPE html>
<html lang="en"><head>
    <title>首页</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#000084" />
    <link rel="icon" href="https://fyzn12.github.io/favicon.ico">
    <link rel="canonical" href="https://fyzn12.github.io">
    
    
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="https://fyzn12.github.io">首页</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                    
                        
                            <li>
                                <a href="/about/">
                                    
                                    <span>About</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/post/">
                                    
                                    <span>All posts</span>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>
</nav><div id="content" class="container">

<div class="row-fluid navmargin">
    <div class="page-header">
        <h1>redis之java客户端 - Wed, Jul 8, 2020</h1>
    </div>
    <p class="lead">Jedis是什么.....</p>
    

<h1 id="1-jedis的简单介绍">1 jedis的简单介绍</h1>

<h2 id="1-1-jedis是什么">1.1 Jedis是什么</h2>

<pre><code>    直观来说，jedis就是redis-cli    
</code></pre>

<div align=center><img src="https://fyzn12.github.io/img/picture/jedis-info.png"/></div>  
  

<h2 id="1-2-引入jedis的依赖包">1.2 引入jedis的依赖包</h2>

<pre><code>     &lt;!-- 引入jedis的依赖包 --&gt;
    &lt;dependency&gt;  
      &lt;groupId&gt;redis.clients&lt;/groupId&gt;  
      &lt;artifactId&gt;jedis&lt;/artifactId&gt;  
      &lt;version&gt;2.9.3&lt;/version&gt;  
      &lt;type&gt;jar&lt;/type&gt;  
      &lt;scope&gt;compile&lt;/scope&gt;  
    &lt;/dependency&gt;   
</code></pre>

<h2 id="1-3-jedis直连">1.3 jedis直连</h2>

<ol>
<li><p>生成一个Jedis对象，这个对象负责和指定Redis节点进行通信<br />
    Jedis jedis = new Jedis(&ldquo;127.0.0.1&rdquo;,6379);</p></li>

<li><p>jedis执行set操作<br />
    jedis.set(&ldquo;hello&rdquo;,&ldquo;world&rdquo;);</p></li>

<li><p>jedis执行get操作，value=&ldquo;world&rdquo;<br />
    String value = jedis.get(&ldquo;hello&rdquo;);</p></li>
</ol>

<div align=center><img src="https://fyzn12.github.io/img/picture/jedis-test.png"/></div>  
    

<h3 id="jedis构造函数的简单介绍">Jedis构造函数的简单介绍</h3>

<pre><code>    Jedis构造方法的参数  
    Jedis(String host,int port,int connectionTimeout,int soTimeout);  
    host:Redis节点的所在机器的IP；  
    port：Redis节点的端口；  
    connectionTimeout：客户端连接超时；  
    soTimeout：客户端读写超时；    
</code></pre>

<h2 id="1-4-jedis直连和连接池的对比">1.4 Jedis直连和连接池的对比</h2>

<div align=center><img src="https://fyzn12.github.io/img/picture/jedispool.png"/></div>   
 

<hr />

<h1 id="2-redis的具体实现">2 redis的具体实现</h1>

<h2 id="2-1-慢查询">2.1 慢查询</h2>

<ul>
<li>生命周期<br /></li>
<li>三个命令<br /></li>
<li>两个配置<br /></li>
<li>运维经验<br />
<br /></li>
</ul>

<h3 id="2-1-1-生命周期">2.1.1 生命周期</h3>

<div align=center><img src="https://fyzn12.github.io/img/picture/live-redis.png"/></div>      
  

<pre><code>    两点说明：  
    （1）慢查询发生在第三阶段  
    （2）客户端超时不一定慢查询，但慢查询是客户端超时的一个可能因素
</code></pre>

<h3 id="2-1-2-慢查询的两个配置">2.1.2 慢查询的两个配置</h3>

<h4 id="1-slowlog-log-slower-than">1. slowlog-log-slower-than</h4>

<pre><code>    1. 慢查询阈值（单位：微秒）  
    2. slowlog-log-slower-than=0：记录所有命令    
    3. slowlog-log-slower-than&lt;0：不记录任何命令
</code></pre>

<h4 id="2-slowlog-max-len">2. slowlog-max-len</h4>

<pre><code>    1. 先进先出  
    2. 固定长度  
    3. 保存在内存中    
</code></pre>

<h3 id="2-1-3-配置方法">2.1.3 配置方法</h3>

<h4 id="1-默认值">1. 默认值</h4>

<ul>
<li>config get slowlog-max-len = 128<br /></li>
<li>config get slowlog-log-slower-than = 10000（阈值）<br />
<br /></li>
</ul>

<h4 id="2-修改配置文件重启">2. 修改配置文件重启</h4>

<h4 id="3-动态配置">3. 动态配置</h4>

<ul>
<li>config set slowlog-max-len 1000<br /></li>
<li>config set slowlog-log-slower-than 1000<br />
<br /></li>
</ul>

<h3 id="2-1-4-慢查询的命令">2.1.4 慢查询的命令</h3>

<h4 id="1-slowlog-get-n-获取慢查询队列">1. slowlog get[n]:获取慢查询队列</h4>

<h4 id="2-slowlog-len-获取慢查询队列长度">2. slowlog len：获取慢查询队列长度</h4>

<h4 id="3-slowlog-reset-清空慢查询队列">3. slowlog reset：清空慢查询队列</h4>

<h3 id="2-1-5-慢查询的运维经验">2.1.5 慢查询的运维经验</h3>

<ol>
<li>slowlog-max-len不要设置过大，默认10ms，通常设置1ms。<br /></li>
<li>slowlog-log-slower-than不要设置过小，通常设置1000左右。<br /></li>
<li>理解命令生命周期。<br /></li>
<li>定期持久化慢查询。<br />
<br />
<br /></li>
</ol>

<hr />

<h1 id="3-springboot整合redis项目实战">3 SpringBoot整合Redis项目实战</h1>

<h2 id="3-1-创建分布式项目">3.1 创建分布式项目</h2>

<ul>
<li>项目结构图如下<br /></li>
<li><div align=center><img src="https://fyzn12.github.io/img/picture/springboot-redis.png"/></div><br />
<br /></li>
</ul>

<h3 id="3-1-1-parent导入的依赖">3.1.1 parent导入的依赖</h3>

<pre><code>    &lt;dependencies&gt;
        &lt;!-- 导入springboot的启动器--&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
          &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- 导入mybatis的启动器 --&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
          &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
          &lt;version&gt;1.2.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- 导入jsp支持jstl--&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
          &lt;artifactId&gt;jstl&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- springboot需要开启支持jsp，因此需要jsp的支持jar --&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt;
          &lt;artifactId&gt;tomcat-embed-jasper&lt;/artifactId&gt;
          &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- mysql的连接jar --&gt;
        &lt;!-- mysql数据库 --&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;mysql&lt;/groupId&gt;
          &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
          &lt;version&gt;8.0.15&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- mysql的连接池 --&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
          &lt;artifactId&gt;druid&lt;/artifactId&gt;
          &lt;version&gt;${druid.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
          &lt;artifactId&gt;mybatis-spring&lt;/artifactId&gt;
          &lt;version&gt;1.3.1&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- 引入jedis的依赖包 --&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
          &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
          &lt;exclusions&gt;
            &lt;exclusion&gt;
              &lt;groupId&gt;redis.clients&lt;/groupId&gt;
              &lt;artifactId&gt;jedis&lt;/artifactId&gt;
            &lt;/exclusion&gt;
            &lt;!--
            &lt;exclusion&gt;
                &lt;groupId&gt;io.lettuce&lt;/groupId&gt;
                &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt;
            &lt;/exclusion&gt;
            --&gt;
          &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;redis.clients&lt;/groupId&gt;
          &lt;artifactId&gt;jedis&lt;/artifactId&gt;
          &lt;version&gt;2.9.3&lt;/version&gt;
          &lt;type&gt;jar&lt;/type&gt;
          &lt;scope&gt;compile&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
          &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;
          &lt;version&gt;2.5.0&lt;/version&gt;
          &lt;!--&lt;version&gt;2.4.2&lt;/version&gt;--&gt;
        &lt;/dependency&gt;
        &lt;!-- 导入单元测试的启动器--&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
          &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;junit&lt;/groupId&gt;
          &lt;artifactId&gt;junit&lt;/artifactId&gt;
          &lt;version&gt;4.12&lt;/version&gt;
          &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
      &lt;/dependencies&gt;  

    注意：parent的项目打包方式是pom，其他项目依赖于该项目  
</code></pre>

<h3 id="3-1-2-创建springboot的配置文件application-properties">3.1.2 创建springboot的配置文件application.properties</h3>

<p>创建该文件需要注意一下几点<br />
* 关于springMVC、redis的配置文件必须根据全称去写如spring.mvc.view.suffix=.jsp不得随意更改=左边的值<br />
* 该文件必须存放于classpath下也就是resources根目录下<br />
* 命名为application.properties</p>

<h4 id="文件内容如下">文件内容如下</h4>

<pre><code>                    # 配置视图解析
                    spring.mvc.view.prefix=/WEB-INF/views/
                    spring.mvc.view.suffix=.jsp

                    # 配置数据库连接参数
                    spring.datasource.driverClassName =com.mysql.cj.jdbc.Driver
                    spring.datasource.url=jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8
                    spring.datasource.username=root
                    spring.datasource.password=123456
                    spring.datasource.type=com.alibaba.druid.pool.DruidDataSource
                    # 指定mapper文件的位置
                    mybatis.mapper-locations=classpath:mapper/*.xml

                    # 配置Jedis
                    #redis jedis配置
                    # Redis数据库索引（默认为0）
                    spring.redis.database=0
                    # Redis服务器地址
                    spring.redis.host=127.0.0.1
                    # Redis服务器连接端口
                    spring.redis.port=6379
                    # Redis服务器连接密码（默认为空）
                    #spring.redis.password=
                    # 连接池最大连接数（使用负值表示没有限制）
                    spring.redis.jedis.pool.max-active=5000
                    # 连接池最大阻塞等待时间（使用负值表示没有限制）
                    spring.redis.jedis.pool.max-wait=-1
                    # 连接池中的最大空闲连接
                    spring.redis.jedis.pool.max-idle=8
                    # 连接池中的最小空闲连接
                    spring.redis.jedis.pool.min-idle=0
                    # 连接超时时间（毫秒）
                    spring.redis.timeout=1000
                    #spring-session 使用
                    spring.session.store-type=none

                    # 定义存放图片的key
                    redis.key=bigImg

                    # 配置静态资源放行
                    spring.resources.static-locations=classpath*:/static/    
</code></pre>

<hr />

<h2 id="3-2-创建redis的连接类redisconfig-java">3.2 创建Redis的连接类RedisConfig.java</h2>

<p>在创建该类时需要了解以下几点<br />
1. @EnableCaching的作用：开启缓存注解；
2. Cacheable作用：把方法的返回值添加到Ehcache中做缓存Value属性：指定一个Ehcache配置文件中的缓存策略，如果么有给定value，name则表示使用默认的缓存策略。<br />
3. @CacheEvict作用：清除缓存<br />
4. @Configuration：具体作用请看博客：<a href="https://www.cnblogs.com/duanxz/p/7493276.html">@Configuration详解</a></p>

<ol>
<li>在SpringBoot2.x之后的版本中官网推荐使用的是lettuce连接池整合Redis，并且删除了一些整合Jedis的方法，因此这里使用Jedis整合Redis时需要重写这些方法，如CacheManager cacheManager(RedisConnectionFactory connectionFactory)方法。<br />
<br /></li>
</ol>

<h3 id="3-2-1-创建该类的内容如下">3.2.1 创建该类的内容如下</h3>

<pre><code>            /**
             * @author fyzn12
             * @version 1.0
             * @date 2020/7/10 9:35
             * @description:TODO
             */
            @Configuration
            @EnableCaching
            public class RedisConfig {

                @Bean
                    //如使用注解的话需要配置cacheManager
                    //此处为与1.x最大的不同
                CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
                    //初始化一个RedisCacheWriter
                    RedisCacheWriter redisCacheWriter = RedisCacheWriter.nonLockingRedisCacheWriter(connectionFactory);
                    RedisCacheConfiguration defaultCacheConfig = RedisCacheConfiguration.defaultCacheConfig();
                    //设置默认超过期时间是1天
                    defaultCacheConfig.entryTtl(Duration.ofDays(1));
                    //初始化RedisCacheManager
                    RedisCacheManager cacheManager = new RedisCacheManager(redisCacheWriter, defaultCacheConfig);
                    return cacheManager;
                }

                // 以下两种redisTemplate自由根据场景选择
                @Bean
                public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory connectionFactory) {
                    RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;();
                    template.setConnectionFactory(connectionFactory);

                    //使用Jackson2JsonRedisSerializer来序列化和反序列化redis的value值（默认使用JDK的序列化方式）
                    Jackson2JsonRedisSerializer serializer = new Jackson2JsonRedisSerializer(Object.class);

                    ObjectMapper mapper = new ObjectMapper();
                    mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
                    mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);
                    serializer.setObjectMapper(mapper);

                    template.setValueSerializer(serializer);
                    //使用StringRedisSerializer来序列化和反序列化redis的key值
                    template.setKeySerializer(new StringRedisSerializer());
                    template.afterPropertiesSet();
                    return template;
                }

                @Bean
                public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory factory) {
                    StringRedisTemplate stringRedisTemplate = new StringRedisTemplate();
                    stringRedisTemplate.setConnectionFactory(factory);
                    return stringRedisTemplate;
                }
            }   
</code></pre>

<h3 id="3-2-2-创建测试类">3.2.2 创建测试类</h3>

<pre><code>        /**
         * @author fyzn12
         * @version 1.0
         * @date 2020/7/10 12:25
         * @description:TODO
         */


        @RunWith(SpringRunner.class)
        @SpringBootTest
        public class RedisTest {

            Logger log = LoggerFactory.getLogger(RedisTest.class);
            @Autowired
            RedisTemplate redisTemplate;
            @Test
            public void contextLoads() {
                //这里相当于redis对String类型的set操作
                redisTemplate.opsForValue().set(&quot;test&quot;,&quot;helloworld&quot;);
                //这里相当于redis对String类型的get操作
                String test = (String)redisTemplate.opsForValue().get(&quot;test&quot;);
                System.out.println(test);
            }
        }  
</code></pre>

<hr />

<h2 id="3-3-项目运行过程中遇到的bug总结">3.3 项目运行过程中遇到的bug总结</h2>

<h3 id="3-3-1-springboot创建分布式项目时-前端访问页面显示下图">3.3.1 springboot创建分布式项目时，前端访问页面显示下图</h3>

<div align=center><img src="https://fyzn12.github.io/img/picture/springboot-error1.png"/></div>   
  

<h4 id="分析上图中的error如下讨论">分析上图中的error如下讨论</h4>

<ul>
<li><p>产生404错误的原因有<br />
    1. 配置的视图解析没有工作；但在该图中，很明显视图解析到了/WEB-INF/views/下，说明视图解析已经成功。<br />
    2. 文件的访问路径与控制器的路径不匹配（在上图中也可以排除）<br />
    3. springboot的启动器没有包含controller，或者与controller处于同级目录；</p></li>

<li><p>以上几种原因在该项目中很明显都不是。</p></li>
</ul>

<h4 id="产生这个原因是因为分布式项目在解析控制器路径时产生的问题-具体原因我也尚未弄清楚-但目前知道有两种方式可以解决">产生这个原因是因为分布式项目在解析控制器路径时产生的问题，具体原因我也尚未弄清楚，但目前知道有两种方式可以解决</h4>

<h5 id="方法一">方法一：</h5>

<ul>
<li>1. 找到项目右侧的 Maven，如图所示<br /></li>
<li><div align=center><img src="https://fyzn12.github.io/img/picture/position-maven.png"/></div><br /></li>
<li>2. 点检Maven之后展开项目，在Plugins下会找到一个spring-boot，将其展开，选择下面的spring-boot：run启动项目<br />
<br /></li>
</ul>

<h5 id="方法二">方法二：</h5>

<p>改变springboot的启动器的配置<br />
1. 选择Edit Configurations 找到Environment，如下图所示
<div align=center><img src="https://fyzn12.github.io/img/picture/edit-configuration1.png"/></div></p>

<ol>
<li>展开Environment之后，选择下面的Working directory，并在其右侧输入： $MODULE_WORKING_DIR$<br /></li>
<li>保存点击ok，再次启动项目，访问即可成功



<br />





<br />

<br /></li>
</ol>

    <h4><a href="https://fyzn12.github.io">Back to Home</a></h4>
</div>


        </div><footer class="container">
    <hr class="soften">
    <p>

    <a href="https://fyzn12.github.io">fyzn12</a> | 

&copy; 
<a href="https://fyzn12.github.io" target="_blank">
    fyzn12
</a>
<span id="thisyear">2020</span>

    | @


        | Built on <a href="//gohugo.io" target="_blank">Hugo</a>
</p>
    <p class="text-center">
        <a href="https://facebook.com">Facebook</a> 
        <a href="https://twitter.com">Twitter</a> 
        <a href="https://linkedin.com">Linkedin</a> 
        <a href="https://github.com">GitHub</a> 
        <a href="https://gitlab.com">GitLab</a>
    </p>
</footer>

</body><link rel="stylesheet" href="/css/bootstrap.css">
<link rel="stylesheet" href="/css/bootstrap-responsive.css">
<link rel="stylesheet" href="/css/style.css">

<script src="/js/jquery.js"></script>
<script src="/js/bootstrap-386.js"></script>
<script src="/js/bootstrap-transition.js"></script>
<script src="/js/bootstrap-alert.js"></script>
<script src="/js/bootstrap-modal.js"></script>
<script src="/js/bootstrap-dropdown.js"></script>
<script src="/js/bootstrap-scrollspy.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<script src="/js/bootstrap-tooltip.js"></script>
<script src="/js/bootstrap-popover.js"></script>
<script src="/js/bootstrap-button.js"></script>
<script src="/js/bootstrap-collapse.js"></script>
<script src="/js/bootstrap-carousel.js"></script>
<script src="/js/bootstrap-typeahead.js"></script>
<script src="/js/bootstrap-affix.js"></script>
<script>
    _386 = { 
        fastLoad: false ,
        onePass: false , 
        speedFactor: 1 
    };

    
    function ThisYear() {
        document.getElementById('thisyear').innerHTML = new Date().getFullYear();
    };
</script></html>
